/**
 * @name GmapsMarkerManager
 * @version 0.2
 * @author Alexander Kaupanin <kaupanin@gmail.com>
 *
 * @fileoverview GmapsMarkerManager - интерфейс для добавления маркеров на карту; маркеры, располагающиеся в непосредственной близости друг от друга на
 * <i>отображаемой карте</i>, объёдиняются в группы и показывается один групповой маркер. При изменении масштаба происходит пересчёт сетки, маркеры разбиваются
 * на новые группы (или объединяются)
 * 
 * <b>Как работает</b>:
 * GmapsMarkerManager располагает свои маркеры на сетке, аналогичной тайлам карты. Когда пользователь изменяет видимую область, происходит пересчёт ячеек 
 * и соответственно группировка-разгруппировка маркеров в видимй области и на небольшой площади за её пределами ()
 */
/**
 * Создаёт экземпляр  GmapsMarkerManager для добавления/удаления маркеров
 *
 * @constructor
 * @param {Map} map карта
 * @param {Object} options объект дополнительных опций:
 *   {Object} cell объект ячейки с её размерами: {width: 48, height: 96}
 *   {Object} icon объект иконки, показываемой для группы маркеров: {src: "/img/icons/group_marker.png", shadow: "/img/icons/group_marker_shadow.png"}
 *   {Number} threshold уровень приближения карты (zoom), при котором не нужно группировать маркеры
 *   {Float} sanity  1.5  "пределы разумного" - коэффициент, который используется для расчёта группировки за пределами видимой области, по умолчанию 1.5
 *           это значит что для видимой области размерами 200х100 sanity-область будет в 1.5 раз больше по каждому измерению, с видимой областью по центу
 *           см. рисунок
 *                                                  _____________300_______________
 *                                                 |       _______200_______      |
 *                                                 |      |                 |     |
 *                                                150    100    viewport    |     |
 *                                                 |      |_________________|     |
 *                                                 |______________________________|
 */
function GmapsMarkerManager(a,b){this.options=b||{},this.marker_size=new google.maps.Size(16,32),this.setMap(a),this.map=a,this.markers=[],this.markers_infowindows=[],this.view_port=new Object,this.view_port.cell=new Object,this.view_port.cells=[],this.view_port.markers=[],this.view_port.cell.width=this.options.cell?this.options.cell.width||!1:this.marker_size.width*3,this.view_port.cell.height=this.options.cell?this.options.cell.height||!1:this.marker_size.height*3,this.view_port.height=this.map.getDiv().offsetHeight,this.view_port.width=this.map.getDiv().offsetWidth,this.view_port.cols_count=Math.ceil(this.view_port.width/this.view_port.cell.width),this.view_port.rows_count=Math.ceil(this.view_port.height/this.view_port.cell.height),this.initial=!0,this.on_zoom=!1,this.threshold_zoom=this.options.threshold||12,this.group_icon_src=this.options.icon?this.options.icon.src||!1:!1,this.group_icon_shadow=this.options.icon?this.options.icon.shadow||!1:!1,this.grid=new Object,this.grid.cells=[],this.grid.markers=[]}GmapsMarkerManager.prototype=new google.maps.OverlayView,GmapsMarkerManager.prototype.addMarker=function(a,b){b=b||!1,this.markers.push(a),this.markers_infowindows.push(b)},GmapsMarkerManager.prototype.removeMarkerByNumber=function(a){this.markers[a].setMap(null),this.markers.splice(a,1),this.initial=!0,this.draw()},GmapsMarkerManager.prototype.clear=function(a){for(var b in this.markers)typeof this.markers[b]=="object"&&this.markers[b].setMap(null);a&&(this.markers=[])},GmapsMarkerManager.prototype.draw=function(){this.initial&&this.refresh();var a=this;google.maps.event.addListener(this.map,"zoom_changed",function(){a.initial=!0})},GmapsMarkerManager.prototype.refresh=function(){this.clear(),this.clearGroupMarkers(),this.buildMapGrid(this.initial),this.checkMarkers(this.markers,this.view_port.cells),this.groupMarkers(),this.initial=!1},GmapsMarkerManager.prototype.clearGroupMarkers=function(a){for(var b=0;b<this.view_port.markers.length;b++)this.view_port.markers[b].alias&&this.view_port.markers[b].alias.setMap(null);return a&&(this.view_port.markers=[]),!0},GmapsMarkerManager.prototype.buildMapGrid=function(a){a=a||!1,this.view_port.cells=this.buildGrid(this.calculateGridOptParams(this.markers));for(var b=0;b<this.view_port.cells.length;b++)if(typeof this.view_port.markers[b]=="undefined"||a)this.view_port.markers[b]=new Object},GmapsMarkerManager.prototype.calculateGridOptParams=function(a){this.sanity=this.options.sanity||1.5;var b={start:{x:0-this.view_port.width*this.sanity,y:0-this.view_port.height*this.sanity},end:{x:this.view_port.width+this.view_port.width*this.sanity,y:this.view_port.height+this.view_port.height*this.sanity},cell:{width:this.view_port.cell.width,height:this.view_port.cell.height}};return b},GmapsMarkerManager.prototype.buildGrid=function(a){var b=[];for(var c=a.start.x;c<a.end.x;c+=a.cell.width)for(var d=a.start.y;d<a.end.y;d+=a.cell.height)b.push(new google.maps.LatLngBounds(this.getProjection().fromDivPixelToLatLng(new google.maps.Point(c,d+a.cell.height)),this.getProjection().fromDivPixelToLatLng(new google.maps.Point(c+a.cell.width,d))));return b},GmapsMarkerManager.prototype.checkMarkers=function(a,b){for(var c=0;c<b.length;c++){this.view_port.markers[c].count=0,this.view_port.markers[c].items=[],this.view_port.markers[c].bounds=b[c];for(var d=0;d<a.length;d++)b[c].contains(a[d].getPosition())&&(this.view_port.markers[c].count++,this.view_port.markers[c].items.push(a[d]))}return!0},GmapsMarkerManager.prototype.groupMarkers=function(){this.threshold=this.map.getZoom()>=this.threshold_zoom?!0:!1;var a=a||new google.maps.InfoWindow;for(var b=0;b<this.view_port.markers.length;b++)if(this.view_port.markers[b].count&&!this.view_port.markers[b].alias){me=this;if(this.threshold)for(var c=0;c<this.view_port.markers[b].items.length;c++)this.view_port.markers[b].items[c].setMap(this.map),google.maps.event.addListener(this.view_port.markers[b].items[c],"click",function(){me.markers_infowindows[b]&&(a.setContent(this.markers_infowindows[b]),a.open(me.map,this))});else{for(var c=0;c<this.view_port.markers[b].items.length;c++)this.view_port.markers[b].items[c].setMap(null);this.view_port.markers[b].count==1?(this.view_port.markers[b].alias=this.view_port.markers[b].items[0],this.view_port.markers[b].alias.setMap(this.map),google.maps.event.addListener(this.view_port.markers[b].alias,"click",function(){me.markers_infowindows[b]&&(a.setContent(this.markers_infowindows[b]),a.open(me.map,this))})):(this.view_port.markers[b].alias=new google.maps.Marker({position:this.view_port.markers[b].items[0].getPosition(),title:this.view_port.markers[b].count.toString()}),this.group_icon_src&&this.view_port.markers[b].alias.setIcon(new google.maps.MarkerImage(this.group_icon_src)),this.group_icon_shadow&&this.view_port.markers[b].alias.setShadow(new google.maps.MarkerImage(this.group_icon_shadow)),this.view_port.markers[b].alias.setMap(this.map))}}}