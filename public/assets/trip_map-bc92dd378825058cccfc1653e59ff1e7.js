function calcRoute(a){var b;a?b=a.map(function(a){return{location:a,stopover:!1}}):trip.google_options["waypoints"]!=undefined?b=trip.google_options.waypoints.map(function(a){return{location:new google.maps.LatLng(a[0],a[1]),stopover:!1}}):b=[];var c={origin:$("#trip_origin").val(),destination:$("#trip_destination").val(),waypoints:b,travelMode:google.maps.TravelMode[selectedMode],unitSystem:google.maps.UnitSystem[unit_system],avoidHighways:$("#avoid_highways:checked").length?!0:!1,avoidTolls:$("#avoid_tolls:checked").length?!0:!1};directionsService.route(c,function(a,b){b==google.maps.DirectionsStatus.OK?(directionsDisplay.setDirections(a),savePath(directionsDisplay.directions.routes[0].overview_path)):console.log(b)})}function savePath(a){var b=a.map(function(a){return[a.lat(),a.lng()]});$("#trip_route").val(JSON.stringify(b))}function click_actions(){$(".adp-summary").live("click",function(){$(this).next().find(".adp-directions").toggle()}),$("#options_toggle a").click(function(){$(this).text()=="Show options"?($("#driving_options").show(),$(this).text("Hide options")):($("#driving_options").hide(),$(this).text("Show options"))}),$("#driving_options input").click(function(){save_waypoints(),calcRoute()})}function watch_waypoints(){$(".waypoint").remove(),clear_markers(waypoint_markers);var a=directionsDisplay.directions.routes[0].legs[0].via_waypoints;for(var b=0;b<a.length;b++){var c=new google.maps.Marker({map:map,position:new google.maps.LatLng(a[b].lat(),a[b].lng()),title:b.toString()});waypoint_markers.push(c),google.maps.event.addListener(c,"dblclick",function(){a.splice(parseInt(this.title),1),calcRoute(a),directionsDisplay.setOptions({preserveViewport:!0,draggable:!0})})}save_waypoints()}function save_waypoints(){var a=directionsDisplay.directions.routes[0].legs[0].via_waypoints.map(function(a){return[a.lat(),a.lng()]}),b=directionsDisplay.directions.routes[0].overview_polyline.points,c={};c.avoid_highways=$("#avoid_highways:checked").length?!0:!1,c.avoid_tolls=$("#avoid_tolls:checked").length?!0:!1,c.waypoints=a,$("#trip_google_options").val(JSON.stringify(c)),$("#trip_encoded_poly").val(b),$("#trip_distance").val(directionsDisplay.directions.routes[0].legs[0].distance.value),$("#trip_duration").val(directionsDisplay.directions.routes[0].legs[0].duration.value),$("#trip_origin").val(directionsDisplay.directions.routes[0].legs[0].start_address),$("#trip_destination").val(directionsDisplay.directions.routes[0].legs[0].end_address)}function waypoint_html(a){return'<div class="waypoint">'+a+"</div>"}function code_latlng(a){geocoder.geocode({latLng:a},function(a,b){b==google.maps.GeocoderStatus.OK?(console.log(a),$("#trip_origin_div").after(waypoint_html(a[1].formatted_address))):alert("Geocoder failed due to: "+b)})}function clear_markers(a){if(a){for(var b=0;b<a.length;b++)a[b].setMap(null);a.length=0}}var rendererOptions={draggable:!0,suppressInfoWindows:!0},directionsDisplay=new google.maps.DirectionsRenderer(rendererOptions),directionsService=new google.maps.DirectionsService,map,geocoder,waypoint_markers=[],selectedMode="DRIVING",unit_system="IMPERIAL";$(function(){set_heights(),$(window).resize(set_heights),geocoder=new google.maps.Geocoder;var a={zoom:7,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(45,-122)};map=new google.maps.Map(document.getElementById("map_canvas"),a),directionsDisplay.setMap(map),directionsDisplay.setPanel(document.getElementById("directionsPanel")),google.maps.event.addListener(directionsDisplay,"directions_changed",function(){watch_waypoints(),savePath(directionsDisplay.directions.routes[0].overview_path)}),click_actions(),calcRoute()})